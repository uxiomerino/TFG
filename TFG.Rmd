---
title: "TFG"
author: "Uxío Merino"
date: "2024-01-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Carga de datos
```{r}
setwd("~/GCED/TFG/Datos")

load("df.RData")
# load("df2.RData") Eurocup
load("df3.RData")

df <- df[df$Mins >= 100 & df$Partidos >= 7, ]
str(df)
df$Año <- rep("2022/23", dim(df)[1])
# 
# df2 <- df2[df2$Mins >= 45 & df2$Partidos >= 3, ]
# df2
# df2$Competicion <- rep("EuroCup", dim(df2)[1])
# df2$Año <- rep("2022/23", dim(df2)[1])

df3 <- df3[df3$Mins >= 50 & df3$Partidos >= 4, ]
df3$Año <- rep("2023/24", dim(df3)[1])

df_union <- rbind(df,df3)
head(df_union)

save(df_union, file="datos.RData")
```

Análise previo:
```{r}
library(naniar)
library(ggplot2)
library(dplyr)

## Datos faltantes
n_miss(df_union) # Non existen datos faltantes 

## Comprobación da integridade dos datos
summary(df_union)

df_union[df_union$PPP < 0, ] # Valores non plausibeis
df_union[df_union$'%Asist' < 0, ] # Valores non plausibeis

df_union[df_union$'%Asist' < 0, '%Asist'] <- 0
df_union[df_union$PPP < 0, 'PPP'] <- 0 
```

Datos atípicos:
```{r}
df_num <- df_union %>% select_if(is.numeric)
vars_norms <- 0
for (col in colnames(df_num)){
  columna <- df_num[[col]]
  hist(columna, prob = T, main = paste("Histograma de", col))
  lines(density(columna), col = "blue", lwd = 2)
  outliers <- length(boxplot(columna, outline = TRUE, main = paste("Boxplot de", col))$out)
  cat("\n\nA var", col, "ten", outliers, "valores atípicos.\n")
  p_valor <- shapiro.test(columna)$p.value
  if (p_valor > 0.05){
    cat("Non cabe rexeitar normalidade para a variable", col, ", cun p-valor de ", p_valor)
    vars_norms <- vars_norms + 1
  }else{
    cat("Rexeitamos a normalidade para a variable", col, ", cun p-valor de ", p_valor)
  }
}

vars_norms
```


Correlación:
```{r}
cor_matrix <- cor(df_num)
cor_matrix
```


PCA:
```{r}
library(factoextra)
library(plotly)

df_pca <- df_union[, -c(3, 6)]
pca <- prcomp(df_pca %>% select_if(is.numeric), scale. = T) # This function includes an automatic standarization of data

fviz_eig(pca, addlabels = TRUE, ylim = c(0, 50))
```

```{r}
fviz_pca_var(pca, col.var = "contrib", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), repel = T)
```


```{r}
loadings <- pca$rotation[, 1:5]
sort(loadings[, 1], decreasing = TRUE) 
```
+: Anotación (tiros de 2), Valoracion, % de rebs (todos), Faltas realizadas, Tapons
-: Tiros de 3 e asistencias
 Xogador interior que destaca pola súa aportación ofensiva
 
```{r}
sort(loadings[, 2], decreasing = TRUE) 
```
+: % de rebotes, % de tiros asistidos, tapons realizados
-: Anotación de 3, Asistencias, Recuperacions e Perdidas
Xogador interior dominante na pintura e intimidador

```{r}
sort(loadings[, 3], decreasing = TRUE)
```
+: Pérdidas, Asistencias, Faltas realizadas
-: Tiros asistidos, anotación (sobre todo de 3), % de rebotes
Manexador de balón, bo asistente e que non destaca pola súa anotación

```{r}
sort(loadings[, 4], decreasing = TRUE) 
```
+: Anotación total, tapones recibidos
-: Asistencias, pérdidas, eficiencia de anotación, tiros asistidos, rebotes
Xogador que destaca pola súa anotación, porcentaxes de tiro baixos porque asume moitos tiros,
finalizador de xogadas

```{r}
sort(loadings[, 5], decreasing = TRUE) 
```
+: Anotación (tiros de 2), valoracion, tiros libres
-: LE, PPP, Faltas recibidas, tapones, rebotes, asistencias
Anotador cerca do aro, penetrador ou interior
```{r}
topN <- list()
n <- 10

for (i in 1:5){
  comp <- pca$x[, i]
  indiv <- df_pca$Xogador[order(comp, decreasing = TRUE)][1:n]
  scores <- comp[order(comp, decreasing = TRUE)][1:n]
  año <- df_union$Año[order(comp, decreasing = TRUE)][1:n]
  topN[[i]] <- data.frame(Indiv = indiv, Año = año, Score = scores)
}

topN[2]
```

```{r}
minN <- list()
n <- 10

for (i in 1:5){
  comp <- pca$x[, i]
  indiv <- df_pca$Xogador[order(comp, decreasing = F)][1:n]
  scores <- comp[order(comp, decreasing = F)][1:n]
  año <- df_union$Año[order(comp, decreasing = F)][1:n]
  minN[[i]] <- data.frame(Indiv = indiv, Año = año, Score = scores)
}

minN[2]
```

```{r}
coord3D <- pca$x[, 1:3]
df3D <- data.frame(pca$x[, 1:3])
df3D$Xogador <- df_pca$Xogador
df3D$Equipo <- df_pca$Equipo
df3D$Año <- df_pca$Año
head(df3D)

top_players <- list()
for (i in 1:3){
  players <- topN[[i]]$Indiv
  for (x in players){
    top_players <- append(top_players, x)
  }
}

df_coords <- df3D %>% filter(Xogador %in% top_players)

plot <- plot_ly(df_coords, x = ~PC1, y = ~PC2, z = ~PC3, type = "scatter3d", mode = "markers", text = ~Xogador)
plot <- plot %>% add_trace(marker = list(size = 3, color = ~PC1, colorscale = "Viridis"))
plot <- plot %>% layout(scene = list(xaxis = list(title = "Comp 1"),
                                     yaxis = list(title = "Comp 2"),
                                     zaxis = list(title = "Comp 3")),
                        title = "Xogadores máis significativos en cada compoñente")
plot
```


DISTANCIAS:

```{r}
# DF para distancias
library(proxy)

df_dist <- data.frame(pca$x[, 1:5])
df_dist$Xogador <- df_pca$Xogador
df_dist$Equipo <- df_pca$Equipo
df_dist$Año <- df_pca$Año
```

```{r}
# funcions
distancia <- function(df, x1, ano1, x2, ano2, method = "Euclidean") {
  xogador1 <- df[df$Xogador == x1 & df$Año == ano1, c('PC1', 'PC2', 'PC3', 'PC4', 'PC5')]
  xogador2 <- df[df$Xogador == x2 & df$Año == ano2, c('PC1', 'PC2', 'PC3', 'PC4', 'PC5')]

  distancia <- proxy::dist(x = xogador1, y = xogador2, method = method)
  
  return(distancia)
}

buscar_xogador <- function(df, x1, equipo = NA, año = "2023/24", method = "Euclidean"){
  coords1 <- df[df$Xogador == x1, c('PC1', 'PC2', 'PC3', 'PC4', 'PC5')]
  if (!is.na(equipo)) df <- df[df$Equipo == equipo, ]
  if (!is.na(año)) df <- df[df$Año == año, ]
  dist_min <- Inf
  
  for (i in 1:dim(df)[1]){
    x2 <- df[i, "Xogador"]
    coords2 <- df[df$Xogador == x2, c('PC1', 'PC2', 'PC3', 'PC4', 'PC5')]
    if (dim(coords1)[1] > 1) coords1 <- coords1[2, ]
    if (x2 != x1){
      dist <- proxy::dist(coords1, coords2, method = method)
      if (dist < dist_min){
        dist_min <- dist
        xogador_final <- x2
      }
    }
  }
  return (c(xogador_final, dist_min))
}
```


Exemplos:
```{r}
# Exemplo de uso funcion sim
xogador1 <- '22 EDY TAVARES'
xogador2 <- '13 SERGIO RODRIGUEZ'
xogador3 <- '0 NIGEL WILLIAMS-GOSS'
xogador4 <- '17 VINCENT POIRIER'

dist1 <- distancia(df_dist, xogador1, "2023/24", xogador2, "2023/24") 
dist1 # Tavares e Sergio Rodr
dist2 <- distancia(df_dist, xogador1, "2023/24", xogador3, "2022/23") 
dist2 # Tavares e Williams-Goss
dist3 <- distancia(df_dist, xogador3, "2022/23", xogador2, "2022/23") 
dist3 # Sergio Rodr e Williams-Goss
dist4 <- distancia(df_dist, xogador1,"2023/24", xogador4, "2023/24") 
dist4 # Tavares e Poirier
```

```{r}
# Exemplo de uso funcion buscar_xogador
x1 <- "22 EDY TAVARES"
buscar_xogador(df_dist, x1, año = "2023/24")
buscar_xogador(df_dist, x1, año = "2022/23")
buscar_xogador(df_dist, x1, equipo = "Monbus Obradoiro")
buscar_xogador(df_dist, x1, equipo = "Monbus Obradoiro", año = "2022/23")
```

APLICACIÓN INDIVIDUAL OBRADOIRO:
```{r}
df_obradoiro <- df_dist[df_dist$Equipo == "Monbus Obradoiro" & df_dist$Año == "2023/24", ]

for (i in df_obradoiro$Xogador){
  c <- buscar_xogador(df_obradoiro, i)
  c2 <- buscar_xogador(df_dist, i, año = "2023/24")
  cat("O xogador máis similar a ", i, " no equipo é ", c[1], "cunha distancia de", as.numeric(c[2]),
      "\nEn toda a BD é ", c2[1], "cunha distancia de", as.numeric(c2[2]),"\n\n")
}
```

```{r}
matriz_datos <- df_obradoiro[, c('PC1', 'PC2', 'PC3', 'PC4', 'PC5')]

distancias <- proxy::dist(x = matriz_datos)
dists <- as.matrix(distancias)
rownames(dists) <- df_obradoiro$Xogador
colnames(dists) <- df_obradoiro$Xogador

dists
```



CLUSTERING NO JERARQUICO:
```{r}
library(cluster)

df_clusters <- df_pca[, -which(names(df_pca) %in% c("Xogador", "Equipo", "Año"))]
df_clusters <- scale(df_clusters)

k_values <- 1:10
fviz_nbclust(df_clusters, kmeans, method = "wss", k.max = max(k_values))
```

```{r}
clusters <- hkmeans(df_clusters, k = 7)

clustered_data <- data.frame(Xogador = df_union$Xogador, Ano = df_union$Año, CLUSTER = clusters$cluster, Equipo = df_union$Equipo)

ordered_clustered_data <- clustered_data[order(clustered_data$CLUSTER), ]

plot_clusters <- data.frame(Xogador = clustered_data$Xogador, Ano = clustered_data$Ano, CLUSTER = clustered_data$CLUSTER, CP1 = pca$x[, 1], CP2 = pca$x[, 2], CP3 = pca$x[, 3])
plot_clusters$NAME_CLUSTER <- paste("Nome: ", plot_clusters$Xogador, "<br>Ano: ", plot_clusters$Ano, "<br>Cluster: ", plot_clusters$CLUSTER)
plot_ly(data = plot_clusters, x = ~CP1, y = ~CP2, z = ~CP3, type = "scatter3d", mode = "markers", marker = list(size = 3, color = ~CLUSTER), text = ~NAME_CLUSTER) %>%
  add_markers() %>%
  layout(scene = list(legend = list(orientation = "h", x = 0.5, y = 1.1)))
```
```{r}
fviz_cluster(list(data = df_clusters, cluster = clusters$cluster))
```

```{r}
ordered_clustered_data[ordered_clustered_data$CLUSTER==6,]
```


CLUSTERING JERARQUICO:
```{r}
clustering_jerarquico <- hclust(dist(df_clusters, method = "euclidean"), method = "complete")
plot(clustering_jerarquico, main = "Dendograma")
```

```{r}
clusters_jerarquico <- cutree(clustering_jerarquico, h = 10.5)

clustered_jerarquico <- data.frame(Xogador = df_union$Xogador, Ano = df_union$Año, Equipo = df_union$Equipo, CLUSTER = clusters_jerarquico)

ordered_clustered_jerarquico <- clustered_jerarquico[order(clustered_jerarquico$CLUSTER), ]

plot_clusters_jerarquico <- data.frame(Xogador = clustered_jerarquico$Xogador, Ano = clustered_jerarquico$Ano, CLUSTER = clustered_jerarquico$CLUSTER, CP1 = pca$x[, 1], CP2 = pca$x[, 2], CP3 = pca$x[, 3])
plot_clusters_jerarquico$NAME_CLUSTER <- paste("Nome: ", plot_clusters_jerarquico$Xogador, "<br>Ano: ", plot_clusters_jerarquico$Ano, "<br>Cluster: ", plot_clusters_jerarquico$CLUSTER)
plot_ly(data = plot_clusters_jerarquico, x = ~CP1, y = ~CP2, z = ~CP3, type = "scatter3d", mode = "markers", marker = list(size = 3, color = ~CLUSTER), text = ~NAME_CLUSTER) %>%
  add_markers() %>%
  layout(scene = list(legend = list(orientation = "h", x = 0.5, y = 1.1)))
```


```{r}
ordered_clustered_jerarquico[ordered_clustered_jerarquico$CLUSTER==6, ]
```