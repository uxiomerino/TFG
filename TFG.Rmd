---
title: "TFG"
author: "Uxío Merino"
date: "2024-01-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Carga de datos
```{r}
setwd("~/GCED/TFG/Datos")

load("df.RData")
load("df3.RData")

df <- df[df$Mins >= 100 & df$Partidos >= 7, ]
str(df)
df$Año <- rep("2022/23", dim(df)[1])

df3 <- df3[df3$Mins >= 50 & df3$Partidos >= 4, ]
df3$Año <- rep("2023/24", dim(df3)[1])

df_union <- rbind(df,df3)
head(df_union)

save(df_union, file="datos.RData")
```

Análise previo:
```{r}
library(naniar)
library(ggplot2)
library(dplyr)

## Datos faltantes
n_miss(df_union) # Non existen datos faltantes 

## Comprobación da integridade dos datos
summary(df_union)

df_union[df_union$PPPos < 0, ] # Valores non plausibeis
df_union[df_union$'%Asist' < 0, ] # Valores non plausibeis

df_union[df_union$'%TAsist' < 0, '%Asist'] <- 0
df_union[df_union$PPP < 0, 'PPPos'] <- 0 
```

Datos atípicos:
```{r}
df_num <- df_union %>% select_if(is.numeric)
vars_norms <- 0
for (col in colnames(df_num)){
  columna <- df_num[[col]]
  hist(columna, prob = T, main = paste("Histograma de", col))
  lines(density(columna), col = "blue", lwd = 2)
  outliers <- length(boxplot(columna, outline = TRUE, main = paste("Boxplot de", col))$out)
  cat("\n\nA var", col, "ten", outliers, "valores atípicos.\n")
  p_valor <- shapiro.test(columna)$p.value
  if (p_valor > 0.05){
    cat("Non cabe rexeitar normalidade para a variable", col, ", cun p-valor de ", p_valor)
    vars_norms <- vars_norms + 1
  }else{
    cat("Rexeitamos a normalidade para a variable", col, ", cun p-valor de ", p_valor)
  }
}

vars_norms
```


Correlación:
```{r}
cor_matrix <- cor(df_num)
cor_matrix
```

```{r}
umbral <- 0.7

pares_correlados <- which(abs(cor_matrix) > umbral & cor_matrix < 1, arr.ind = TRUE)
nrow(pares_correlados) / ((nrow(cor_matrix)^2)/2)

# Mostrar los pares de variables
# for (i in 1:nrow(pares_correlados)) {
#   row_index <- pares_correlados[i, 1]
#   col_index <- pares_correlados[i, 2]
#   
#   var1 <- rownames(cor_matrix)[row_index]
#   var2 <- colnames(cor_matrix)[col_index]
#   
#   cat("Variables con correlación superior ao umbral:", umbral, ":", var1, "e", var2, "\n")
# }
```


PCA:
```{r}
library(factoextra)
library(plotly)

df_pca <- df_union[, -c(3, 7)]
pca <- prcomp(df_pca %>% select_if(is.numeric), scale. = T) # This function includes an automatic standarization of data

fviz_eig(pca, addlabels = TRUE, ylim = c(0, 40))
```

```{r}
fviz_pca_var(pca, col.var = "contrib", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), repel = T)
```


```{r}
loadings <- pca$rotation[, 1:5]
sort(loadings[, 1], decreasing = TRUE) 
barplot(loadings[, 1], las = 2, cex.names = 0.8, main = "Contribución das variables á Dimensión 1",
        xlab = "Variable", ylab = "Loading en Dimensión 1", col = "skyblue", border = "black")
```
+: Anotación de 3
-: Anotación (de 2), Val, FRealizadas, TL
En positivo, xogador que non ten moito peso no equipo, ppalmente exterior.
En negativo, xogador interior que destaca pola súa aportación ofensiva
 
```{r}
sort(loadings[, 2], decreasing = TRUE)
barplot(loadings[, 2], las = 2, cex.names = 0.8, main = "Contribución das variables á Dimensión 2",
        xlab = "Variable", ylab = "Loading en Dimensión 2", col = "skyblue", border = "black")
```
+: Anotación de 3, Asistencias, Recuperacions e Perdidas
-: % de rebotes, % de tiros asistidos (de 2), tapons realizados
En positivo, xogador exterior, tirador e bo manexador de balón
En negativo, xogador interior dominante na zona e intimidador

```{r}
sort(loadings[, 3], decreasing = TRUE)
barplot(loadings[, 3], las = 2, cex.names = 0.8, main = "Contribución das variables á Dimensión 3",
        xlab = "Variable", ylab = "Loading en Dimensión 3", col = "skyblue", border = "black")
```
+: Pérdidas, Asistencias, Faltas realizadas
-: Tiros asistidos, anotación (sobre todo de 3)
En positivo, manexador de balón, bo asistente e que non destaca pola súa anotación
En negativo, anotador exterior tras pase que ten pouco o balon

```{r}
sort(loadings[, 4], decreasing = TRUE) 
barplot(loadings[, 4], las = 2, cex.names = 0.8, main = "Contribución das variables á Dimensión 4",
        xlab = "Variable", ylab = "Loading en Dimensión 4", col = "skyblue", border = "black")
```
+: Moito volume de tiros (non asistidos), TRec, anotacion, LE (variación dos compañeiros, moitos minutos)
-: Asistencias, perdidas, eficiencia anotadora, recuperacions
En positivo, tirador que destaca pola súa anotación pero pouca eficiencia porque asume moitos tiros
En negativo, manexador de balón con boa eficiencia anotadora e destacado en asistencias

```{r}
sort(loadings[, 5], decreasing = TRUE) 
barplot(loadings[, 5], las = 2, cex.names = 0.8, main = "Contribución das variables á Dimensión 5",
        xlab = "Variable", ylab = "Loading en Dimensión 5", col = "skyblue", border = "black")
```
+: LE (variación de compañeiros), FRec, Perdidas, %Rebotes, Faltas, 
-: Eficiencia anotando (de 2), anotación (sobretodo de 2)
En negativo, xogador eficiente e que anota

```{r}
topN <- list()
n <- 10

for (i in 1:5){
  comp <- pca$x[, i]
  indiv <- df_pca$Xogador[order(comp, decreasing = TRUE)][1:n]
  scores <- comp[order(comp, decreasing = TRUE)][1:n]
  año <- df_union$Año[order(comp, decreasing = TRUE)][1:n]
  topN[[i]] <- data.frame(Indiv = indiv, Año = año, Score = scores)
}

topN[2]
```

```{r}
minN <- list()
n <- 10

for (i in 1:5){
  comp <- pca$x[, i]
  indiv <- df_pca$Xogador[order(comp, decreasing = F)][1:n]
  scores <- comp[order(comp, decreasing = F)][1:n]
  año <- df_union$Año[order(comp, decreasing = F)][1:n]
  minN[[i]] <- data.frame(Indiv = indiv, Año = año, Score = scores)
}

minN[2]
```

```{r}
# Visualizacions en 2D
for (i in 1:4){
  for (j in 2:5){
    if (i != j)    plot(fviz_pca_ind(pca, axes = c(i, j)))
  }
}
```





```{r}
coord3D <- pca$x[, 1:3]
df3D <- data.frame(pca$x[, 1:3])
df3D$Xogador <- df_pca$Xogador
df3D$Equipo <- df_pca$Equipo
df3D$Año <- df_pca$Año
head(df3D)


plot <- plot_ly(df3D, x = ~PC1, y = ~PC2, z = ~PC3, type = "scatter3d", mode = "markers", text = ~Xogador)
plot <- plot %>% add_trace(marker = list(size = 3, color = ~PC1, colorscale = "Viridis"))
plot <- plot %>% layout(scene = list(xaxis = list(title = "Comp 1"),
                                     yaxis = list(title = "Comp 2"),
                                     zaxis = list(title = "Comp 3")),
                        title = "Xogadores máis significativos en cada compoñente")
plot
```


## DISTANCIAS:

```{r}
library(proxy)

df_dist <- data.frame(pca$x[, 1:5])
df_dist$Xogador <- df_pca$Xogador
df_dist$Equipo <- df_pca$Equipo
df_dist$Año <- df_pca$Año
```

```{r}
# UTILIDADES DO PCA

distancia <- function(df, x1, ano1, x2, ano2, method = "Euclidean") {
  xogador1 <- df[df$Xogador == x1 & df$Año == ano1, c('PC1', 'PC2', 'PC3', 'PC4', 'PC5')]
  xogador2 <- df[df$Xogador == x2 & df$Año == ano2, c('PC1', 'PC2', 'PC3', 'PC4', 'PC5')]

  distancia <- proxy::dist(x = xogador1, y = xogador2, method = method)
  
  return(distancia)
}

buscar_xogador <- function(df, x1, equipo = NA, año = "2023/24", method = "Euclidean"){
  
  df <- df[df$Año == año, ]
  coords1 <- df[df$Xogador == x1, c('PC1', 'PC2', 'PC3', 'PC4', 'PC5')]
  if (!is.na(equipo)) df <- df[df$Equipo == equipo, ]
  
  dist_min <- Inf
  
  for (i in 1:dim(df)[1]){
    x2 <- df[i, "Xogador"]
    coords2 <- df[i, c('PC1', 'PC2', 'PC3', 'PC4', 'PC5')]
    if (x2 != x1){
      dist <- proxy::dist(coords1, coords2, method = method)
      if (dist < dist_min){
        dist_min <- dist
        xogador_final <- x2
      }
    }
  }
  return (c(xogador_final, dist_min))
}

busqueda_xogadores_cercanos <- function(df, x1, distancia, equipo = NA, año = "2023/24", method = "Euclidean"){
  
  if (!is.na(año)) df <- df[df$Año == año, ]
  coords1 <- df[df$Xogador == x1, c('PC1', 'PC2', 'PC3', 'PC4', 'PC5')]
  if (!is.na(equipo)) df <- df[df$Equipo == equipo, ]
  
  xogadores <- c()
  total <- c()
  
  for (i in 1:dim(df)[1]){
    x2 <- df[i, "Xogador"]
    coords2 <- df[i, c('PC1', 'PC2', 'PC3', 'PC4', 'PC5')]
    if (x2 != x1){
      dist <- proxy::dist(coords1, coords2, method = method)
      if (dist < distancia){
        xogadores <- c(xogadores, x2)
        total <- c(total, list(x2, dist))
      }
    }
  }
  return (list(xogadores, total))
}
```


Exemplos:
```{r}
# Exemplo de uso funcion distancia

distancia(df_dist, '22 EDY TAVARES', "2023/24", '13 SERGIO RODRIGUEZ', "2023/24")
distancia(df_dist, '22 EDY TAVARES', "2023/24", '0 NIGEL WILLIAMS-GOSS', "2022/23")
distancia(df_dist, '0 NIGEL WILLIAMS-GOSS', "2022/23", '13 SERGIO RODRIGUEZ', "2022/23")
distancia(df_dist, '22 EDY TAVARES',"2023/24", '17 VINCENT POIRIER', "2023/24") 
```

```{r}
# Exemplo de uso funcion buscar_xogador
buscar_xogador(df_dist, "22 EDY TAVARES", año = "2023/24")
buscar_xogador(df_dist, "22 EDY TAVARES", año = "2022/23")
buscar_xogador(df_dist, "22 EDY TAVARES", equipo = "Monbus Obradoiro")
buscar_xogador(df_dist, "22 EDY TAVARES", equipo = "Monbus Obradoiro", año = "2022/23")
```

```{r}
# Exemplo de uso da funcion busqueda_xogadores_cercanos
busqueda_xogadores_cercanos(df_dist, "22 EDY TAVARES", distancia = 5, año = "2022/23")[1]
busqueda_xogadores_cercanos(df_dist, "0 MARKUS HOWARD", distancia = 5)[1]
```

# APLICACIÓN INDIVIDUAL OBRADOIRO:
```{r}
df_obradoiro <- df_dist[df_dist$Equipo == "Monbus Obradoiro" & df_dist$Año == "2023/24", ]

for (i in df_obradoiro$Xogador){
  c <- buscar_xogador(df_dist, i, equipo = "Monbus Obradoiro", año = "2023/24")
  c2 <- buscar_xogador(df_dist, i, año = "2023/24")
  cat("O xogador máis similar a", i, "no equipo é", c[1], "cunha distancia de", as.numeric(c[2]),
      "\nEn toda a BD é", c2[1], "cunha distancia de", as.numeric(c2[2]),"\n\n")
}
```

```{r}
matriz_datos <- df_obradoiro[, c('PC1', 'PC2', 'PC3', 'PC4', 'PC5')]

distancias <- proxy::dist(x = matriz_datos)
dists <- as.matrix(distancias)
rownames(dists) <- df_obradoiro$Xogador
colnames(dists) <- df_obradoiro$Xogador

dists
```

## CLUSTERING JERARQUICO: distancia de mahalanobis
```{r}
library(cluster)

df_clusters <- df_pca[, -which(names(df_pca) %in% c("Xogador", "Equipo", "Año"))]
df_clusters <- scale(df_clusters)
summary(df_clusters)
```


```{r}
metodos = c("ward.D", "ward.D2", "single", "complete", "average", "mcquitty", "median", "centroid")
for (metodo in metodos){
  clustering_jerarquico <- hclust(dist(df_clusters, method = "mahalanobis"), method = metodo)
  plot(clustering_jerarquico, main = "Dendograma")
}
```

```{r}
clustering_jerarquico <- hclust(dist(df_clusters, method = "mahalanobis"), method = "ward.D")
clusters_jerarquico <- cutree(clustering_jerarquico, h = 30)

clustered_jerarquico <- data.frame(Xogador = df_union$Xogador, Ano = df_union$Año, Equipo = df_union$Equipo, CLUSTER = clusters_jerarquico)

ordered_clustered_jerarquico <- clustered_jerarquico[order(clustered_jerarquico$CLUSTER), ]

plot_clusters_jerarquico <- data.frame(Xogador = clustered_jerarquico$Xogador, Ano = clustered_jerarquico$Ano, CLUSTER = clustered_jerarquico$CLUSTER, CP1 = pca$x[, 1], CP2 = pca$x[, 2], CP3 = pca$x[, 3])
plot_clusters_jerarquico$NAME_CLUSTER <- paste("Nome: ", plot_clusters_jerarquico$Xogador, "<br>Ano: ", plot_clusters_jerarquico$Ano, "<br>Cluster: ", plot_clusters_jerarquico$CLUSTER)
plot_ly(data = plot_clusters_jerarquico, x = ~CP1, y = ~CP2, z = ~CP3, type = "scatter3d", mode = "markers", marker = list(size = 3, color = ~CLUSTER), text = ~NAME_CLUSTER) %>%
  add_markers() %>%
  layout(scene = list(legend = list(orientation = "h", x = 0.5, y = 1.1)))
```

```{r}
plot(clustering_jerarquico)
rect.hclust(clustering_jerarquico, k = 6)

library(dendextend)
dend <- as.dendrogram(clustering_jerarquico)
dend_colored <- color_branches(dend, k = 6)
plot(dend_colored)
```


```{r}
for (i in 1:4){
  for (j in 2:5){
    if (i != j)    {
      plot(fviz_pca_ind(pca, axes = c(i, j), col.ind = as.factor(clustered_jerarquico$CLUSTER)))
      print(fviz_cluster(list(data = df_clusters, cluster = clustered_jerarquico$CLUSTER), axes = c(i, j)))
    }
  }
}
```

```{r}
ordered_clustered_jerarquico[ordered_clustered_jerarquico$CLUSTER== 1, ]
```




## CLUSTERING JERARQUICO: distancia euclídea
```{r}
metodos = c("ward.D", "ward.D2", "single", "complete", "average", "mcquitty", "median", "centroid")
for (metodo in metodos){
  clustering_jerarquico_euclideo <- hclust(dist(df_clusters, method = "euclidean"), method = metodo)
  plot(clustering_jerarquico_euclideo, main = "Dendograma")
}
```

```{r}
clustering_jerarquico_euclideo <- hclust(dist(df_clusters, method = "euclidean"), method = "ward.D")
clusters_jerarquico_euclideo <- cutree(clustering_jerarquico_euclideo, k = 6)

clustered_jerarquico_euclideo <- data.frame(Xogador = df_union$Xogador, Ano = df_union$Año, Equipo = df_union$Equipo, CLUSTER = clusters_jerarquico_euclideo)

ordered_clustered_jerarquico_euclideo <- clustered_jerarquico_euclideo[order(clustered_jerarquico_euclideo$CLUSTER), ]

plot_clusters_jerarquico_euclideo <- data.frame(Xogador = clustered_jerarquico_euclideo$Xogador, Ano = clustered_jerarquico_euclideo$Ano, CLUSTER = clustered_jerarquico_euclideo$CLUSTER, CP1 = pca$x[, 1], CP2 = pca$x[, 2], CP3 = pca$x[, 3])
plot_clusters_jerarquico_euclideo$NAME_CLUSTER <- paste("Nome: ", plot_clusters_jerarquico_euclideo$Xogador, "<br>Ano: ", plot_clusters_jerarquico_euclideo$Ano, "<br>Cluster: ", plot_clusters_jerarquico_euclideo$CLUSTER)
plot_ly(data = plot_clusters_jerarquico_euclideo, x = ~CP1, y = ~CP2, z = ~CP3, type = "scatter3d", mode = "markers", marker = list(size = 3, color = ~CLUSTER), text = ~NAME_CLUSTER) %>%
  add_markers() %>%
  layout(scene = list(legend = list(orientation = "h", x = 0.5, y = 1.1)))
```

```{r}
plot(clustering_jerarquico_euclideo)
rect.hclust(clustering_jerarquico_euclideo, k = 6)

library(dendextend)
dend <- as.dendrogram(clustering_jerarquico_euclideo)
dend_colored <- color_branches(dend, k = 6)
plot(dend_colored)
```

```{r}
for (i in 1:4){
  for (j in 2:5){
    if (i != j)    {
      plot(fviz_pca_ind(pca, axes = c(i, j), col.ind = as.factor(clustered_jerarquico_euclideo$CLUSTER)))
      print(fviz_cluster(list(data = df_clusters, cluster = clustered_jerarquico_euclideo$CLUSTER), axes = c(i, j)))
    }
  }
}
```

```{r}
ordered_clustered_jerarquico_euclideo[ordered_clustered_jerarquico_euclideo$CLUSTER== 5, ]
```




## ANALISIS DOS PERFIS DOS EQUIPOS

```{r}
ordered_clustered_jerarquico_euclideo[ordered_clustered_jerarquico_euclideo$Equipo == "Monbus Obradoiro" & ordered_clustered_jerarquico_euclideo$Ano == "2023/24", ]
```



```{r}
clusters_equipos <- ordered_clustered_jerarquico_euclideo %>%
  group_by(Equipo, Ano, CLUSTER) %>%
  summarise(nXogadores = n())

# Muestra el resultado
print(clusters_equipos)
```

```{r}
clusters_equipos[clusters_equipos$Equipo == "Monbus Obradoiro", ]
```






## MODELOS DE REGRESIÓN:

```{r}
load("~/GCED/TFG/Datos/quintetos22-23.RData")
quintetos22_23$Ano <- rep("2022/23", length(quintetos22_23$Equipo))

dim(quintetos22_23)
head(quintetos22_23)
```


```{r}
library(tidyr)
df_combinaciones <- separate(quintetos22_23, Xogadores, into = c("Xogador 1", "Xogador 2", "Xogador 3", "Xogador 4", "Xogador 5"), sep = "(?<=\\D) (?=\\d)")
n_miss(df_combinaciones)
head(df_combinaciones)
```

```{r}
df_combinaciones[which.max(df_combinaciones$Minutos), ]
df_combinaciones[which.max(df_combinaciones$Diferencia), ]
df_combinaciones[which.min(df_combinaciones$Minutos), ]
```


```{r}
xogadores_validos <- unique(df_union[df_union$Año == "2022/23", "Xogador"])
cluster_1 <- c()
cluster_2 <- c()
cluster_3 <- c()
cluster_4 <- c()
cluster_5 <- c()

indices <- c()

for (i in 1:nrow(df_combinaciones)) {
  quinteto <- df_combinaciones[i, c("Xogador 1", "Xogador 2", "Xogador 3", "Xogador 4", "Xogador 5")]
  xogadores_quinteto <- unlist(quinteto)
  
  if (all(xogadores_quinteto %in% xogadores_validos)) {
    # Todos los jugadores de la fila están en la lista de jugadores válidos
    clusters_quinteto <- c()
    for (xogador in xogadores_quinteto) {
      cluster <- ordered_clustered_jerarquico_euclideo$CLUSTER[ordered_clustered_jerarquico_euclideo$Xogador == xogador 
                                                               & ordered_clustered_jerarquico_euclideo$Ano == "2022/23"]
      clusters_quinteto <- c(clusters_quinteto, cluster)
    }
    cluster_1 <- c(cluster_1, unlist(clusters_quinteto)[1])
    cluster_2 <- c(cluster_2, unlist(clusters_quinteto)[2])
    cluster_3 <- c(cluster_3, unlist(clusters_quinteto)[3])
    cluster_4 <- c(cluster_4, unlist(clusters_quinteto)[4])
    cluster_5 <- c(cluster_5, unlist(clusters_quinteto)[5])
    
  } else {
    # Al menos un jugador de la fila no está en la lista de jugadores válidos, eliminar la fila
    indices <- c(indices, i)
  }
}


df_combinaciones <- df_combinaciones[-indices, ]

df_combinaciones$Cluster1 <- cluster_1
df_combinaciones$Cluster2 <- cluster_2
df_combinaciones$Cluster3 <- cluster_3
df_combinaciones$Cluster4 <- cluster_4
df_combinaciones$Cluster5 <- cluster_5

df_combinaciones$Cluster1 <- as.factor(df_combinaciones$Cluster1)
df_combinaciones$Cluster2 <- as.factor(df_combinaciones$Cluster2)
df_combinaciones$Cluster3 <- as.factor(df_combinaciones$Cluster3)
df_combinaciones$Cluster4 <- as.factor(df_combinaciones$Cluster4)
df_combinaciones$Cluster5 <- as.factor(df_combinaciones$Cluster5)
```



## Análisis de la distribución de minutos para seleccionar el umbral
```{r}
summary(df_combinaciones$Minutos)

hist(df_combinaciones$Minutos, prob = T, breaks = "FD", main = paste("Histograma dos minutos"))
lines(density(df_combinaciones$Minutos), col = "blue", lwd = 2)

length(boxplot(df_combinaciones$Minutos, outline = TRUE, main = paste("Boxplot de minutos"))$out)
```

```{r}
df_combinaciones <- df_combinaciones[df_combinaciones$Minutos > 2.27, ]
head(df_combinaciones)
```

```{r}
summary(df_combinaciones$Minutos)
```

```{r}
df_parcial <- df_combinaciones[, c("Cluster1", "Cluster2", "Cluster3", "Cluster4", "Cluster5")]
df_quintetos <- data.frame(matrix(ncol = 6, nrow = nrow(df_parcial)))
colnames(df_quintetos) <- c("C1", "C2", "C3", "C4", "C5", "C6")

for (i in (1:nrow(df_parcial))){
  clusters_quinteto <- numeric(6)
  for (j in (1:ncol(df_parcial))){
    if (df_parcial[i, j] == 1) clusters_quinteto[1] = clusters_quinteto[1] + 1
    if (df_parcial[i, j] == 2) clusters_quinteto[2] = clusters_quinteto[2] + 1
    if (df_parcial[i, j] == 3) clusters_quinteto[3] = clusters_quinteto[3] + 1
    if (df_parcial[i, j] == 4) clusters_quinteto[4] = clusters_quinteto[4] + 1
    if (df_parcial[i, j] == 5) clusters_quinteto[5] = clusters_quinteto[5] + 1
    if (df_parcial[i, j] == 6) clusters_quinteto[6] = clusters_quinteto[6] + 1
  }
   df_quintetos[i, ] <- clusters_quinteto
}

df_quintetos$Dif <- df_combinaciones$Diferencia
head(df_quintetos)
```

```{r}
axuste <- lm(Dif~C1+C2+C3+C4+C5+C6, data = df_quintetos)
summary(axuste)
```

```{r}
axuste_interaccions <- lm(Dif~C1*C2*C3*C4*C5*C6, data = df_quintetos)
summary(axuste_interaccions)
```